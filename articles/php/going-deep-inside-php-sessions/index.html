<!DOCTYPE html>
<!--[if !IE]><!--> <html lang="en-US"> <!--<![endif]-->
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Going Deep Inside PHP Sessions</title>
    <link rel="profile" href="http://gmpg.org/xfn/11" />
    
    <meta property="og:type" content="blog" />
    <meta property="og:title" content="Joseph Crawford" />
    <meta property="og:url" content="http://www.josephcrawford.com" />
    <meta property="og:site_name" content="Joseph Crawford" />
    
        <!--[if IE 6]> <meta http-equiv="refresh" content="1;url=/home/codeb2/public_html/jcrawford/wp-content/themes/radiostation/assets/styles/_ie/kill_ie6/ie6.html"><![endif]-->
    <!--[if IE 7]> <link rel="stylesheet" type="text/css" href="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/styles/_ie/ie7.css"> <![endif]-->
    <!--[if IE 8]> <link rel="stylesheet" type="text/css" href="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/styles/_ie/ie8.css"> <![endif]-->
    <!--[if IE 9]> <link rel="stylesheet" type="text/css" href="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/styles/_ie/ie9.css"> <![endif]-->
    <!--[if lt IE 10]> <link rel="stylesheet" type="text/css" href="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/styles/_ie/ie.css"> <![endif]-->

    <style type="text/css">
        .floatleft {
            float: left;
            margin: 0px 10px 10px 0px;
            border: 1px solid #000000;
            padding: 2px;
            display: inline;
        }

        .floatcenter {
            text-align: center;
            margin: 0px 10px 10px 0px;
            border: 1px solid #000000;
            padding: 2px;
        }

        .floatright {
            float: right;
            margin: 0px 0px 10px 10px;
            border: 1px solid #000000;
            padding: 2px;
            display: inline;
        }
    </style>

    <script type="text/javascript">
    /* <![CDATA[ */
        var imageResize = "wordpress",
            resizeDisabled = "",
            assetsUri = "/images/production",
            imageNonce = "7072fe5b36";
        document.write('<style type="text/css">.noscript{visibility: hidden;}</style>');
    /* ]]> */
    </script>
    


    <link rel='stylesheet' id='pygments-css'  href='/css/pygments.css' type='text/css' media='screen' /> 
    <link rel='stylesheet' id='miss_prettyphoto-css'  href='/css/prettyPhoto.css' type='text/css' media='screen' />
    <link rel='stylesheet' id='missfont1-css'  href='http://fonts.googleapis.com/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C700italic%2C800italic%2C400%2C800%2C700%2C600%2C300&#038;ver=1.0.8' type='text/css' media='screen' />
    <link rel='stylesheet' id='missfont2-css'  href='http://fonts.googleapis.com/css?family=Droid+Sans%3A400%2C700&#038;ver=1.0.8' type='text/css' media='screen' />
    <link rel='stylesheet' id='missfont3-css'  href='http://fonts.googleapis.com/css?family=Lato%3A300%2C400%2C700%2C300italic%2C400italic%2C700italic%2C900%2C900italic&#038;ver=1.0.8' type='text/css' media='screen' />
    <link rel='stylesheet' id='missfont4-css'  href='http://fonts.googleapis.com/css?family=Monda' type='text/css' media='screen' />
    
    <link rel='stylesheet' id='missshortcodes-css'  href='/css/shortcodes.css' type='text/css' media='screen' />
	<link rel='stylesheet' id='misswidgets-css'  href='/css/widgets.css' type='text/css' media='screen' />
    <link rel='stylesheet' id='missgeneral-css'  href='/css/style.css' type='text/css' media='screen' />
    <link rel='stylesheet' id='missresponsive-css'  href='/css/responsive.css' type='text/css' media='screen' />
    <link rel='stylesheet' id='missscore-css'  href='/css/score.css' type='text/css' media='screen' /> 
    <link rel='stylesheet' id='dropkick-css'  href='/css/jquery.selectbox.css' type='text/css' media='screen' />
    
    <link rel='stylesheet' id='light_lightblue-css'  href='/css/themes/light_lightblue.css' type='text/css' media='screen' title="light_lightblue" />
    <link rel='alternate stylesheet' id='gravity-css'  href='/css/themes/gravity.css' type='text/css' media='screen' title="gravity" />	
    <link rel='alternate stylesheet' id='dark_blue-css'  href='/css/themes/dark_blue.css' type='text/css' media='screen' title="dark_blue" />
    <link rel='alternate stylesheet' id='dark_coral-css'  href='/css/themes/dark_coral.css' type='text/css' media='screen' title="dark_coral" />
    <link rel='alternate stylesheet' id='dark_glance-css'  href='/css/themes/dark_glance.css' type='text/css' media='screen' title="dark_glance" />
    <link rel='alternate stylesheet' id='dark_crimson-css'  href='/css/themes/dark_crimson.css' type='text/css' media='screen' title="dark_crimson" />
    <link rel='alternate stylesheet' id='dark_glance-css'  href='/css/themes/dark_glance.css' type='text/css' media='screen' title="dark_glance" />
    <link rel='alternate stylesheet' id='dark_green-css'  href='/css/themes/dark_green.css' type='text/css' media='screen' title="dark_green" />
    <link rel='alternate stylesheet' id='dark_hotpink-css'  href='/css/themes/dark_hotpink.css' type='text/css' media='screen' title="dark_hotpink" />

    <link rel='stylesheet' id='override-css'  href='/css/override.css' type='text/css' media='screen' /> 
    <style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
        <script type='text/javascript' src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type='text/javascript' src="/js/style-switcher.js"></script>
	<script type='text/javascript' src="/js/jquery.selectbox-0.2.min.js"></script>
    <script type='text/javascript' src='/js/jquery.prettyPhoto.js'></script>
    <script type='text/javascript' src='/js/tabs.min.js'></script>
    <script type='text/javascript' src='/js/jquery.flexslider-min.js'></script>
    <script type='text/javascript' src='/js/custom.js'></script>
    <script type='text/javascript' src='/js/stemmer.js'></script>
    <script type='text/javascript' src='/js/site-search.js'></script>

    <meta name="generator" content="Jekyll 0.11.2" />
    <link rel='shortlink' href='http://wp.me/sEFF' />

    <!-- Jetpack Open Graph Tags -->

    <script type="text/javascript">
		$(document).ready(function() {
			var cookie = readCookie("style");
			var title = cookie ? cookie : getPreferredStyleSheet();
			setActiveStyleSheet(title);
			
			$("#switcher").selectbox({
				onChange: function (val, inst) {
					setActiveStyleSheet(val);
				},
			});
			
		});
	
        // var _gaq = _gaq || [];
        // _gaq.push(['_setAccount', 'UA-18267810-1']);
        // _gaq.push(['_trackPageview']);
        (function() {
           // var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
           // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
           // var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
		

    </script>
    

</head>

<body class="has_slider slider_nav_ flexslider has_header_social has_header_text is_home right_sidebar">
    <div class="background">
        <div class="background_inner"></div>
    </div>

    <div id="page_inner">
        <div class="top-pattern"></div>
        <div class="container">
            <div class="sixteen columns">
                <div id="header_extras">
                    <div class="header_social">
                        <div class="social_icon default">
                            <a href="http://twitter.com/josephcrawford"><img src="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/images/sociables/default/twitter.png" alt="" /></a>
                        </div>
                        <div class="social_icon default">
                            <a href="https://www.facebook.com/joseph.crawford.16">
                                <img src="http://www.josephcrawford.com/wp-content/themes/radiostation/assets/images/sociables/default/facebook.png" alt="" />
                            </a>
                        </div>
                    </div>
                    <div class="header_text">I also waste time on the following social networks:</div>
                    <div class="clearboth"></div>
                </div><!-- #header_extras -->
            </div>
            <div id="header">
                <div class="sixteen columns">
                    <div class="logo">
                        <a rel="home" href="http://www.josephcrawford.com/" class="site_title">
                            <span>Joseph</span><span>Crawford</span>
                        </a>
                    </div><!-- .logo -->
                    <div id="header_ad">
                    <script type="text/javascript">
                        <!--
                            google_ad_client = "ca-pub-4815878521361271";
                            /* header right */
                            google_ad_slot = "4528456168";
                            google_ad_width = 234;
                            google_ad_height = 60;
                        //-->
                    </script>

                    <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
                </div>
            </div>
        </div><!-- #header -->
        
                <div id="main_menu" class="sixteen columns row">
            <div class="main_navigation">
                <ul id="menu-menu" class="">
                    <li id="menu-item-1135" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home">
                        <a href="/"><span>Home</span></a>
                    </li>
                    <li id="menu-item-2069" class="menu-item menu-item-type-custom menu-item-object-custom menu_arrow">
                        <a href="#"><span>Articles</span></a>
                        <ul class="sub-menu">
                            <li id="menu-item-2070" class="menu-item menu-item-type-custom menu-item-object-custom menu_arrow"><a href="/articles/javascript/">JavaScript</a><ul class="sub-menu"><li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="/articles/javascript/a-test-article/">A Test Article</a></li></ul><li id="menu-item-2070" class="menu-item menu-item-type-custom menu-item-object-custom menu_arrow"><a href="/articles/php/">PHP</a><ul class="sub-menu"><li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="/articles/php/an-offensive-word-filter/">An Offensive Word Filter</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="/articles/php/going-deep-inside-php-sessions/">Going Deep Inside PHP Sessions</a></li></ul><li id="menu-item-2070" class="menu-item menu-item-type-custom menu-item-object-custom menu_arrow"><a href="/articles/ruby/">Ruby</a><ul class="sub-menu"><li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="/articles/ruby/a-test-article/">Blogging with Jekyll</a></li></ul></li>
                        </ul>
                    </li>
                    <li id="menu-item-1134" class="menu-item menu-item-type-post_type menu-item-object-page">
                        <a href="/about/"><span>About</span></a>
                    </li>
                    <li id="menu-item-2021" class="menu-item menu-item-type-custom menu-item-object-custom menu_arrow">
                        <a href="#"><span>Resume</span></a>
                        <ul class="sub-menu">
                            <li id="menu-item-2022" class="menu-item menu-item-type-custom menu-item-object-custom">
                                <a href="/resume/resume.pdf">PDF</a>
                            </li>
                            <li id="menu-item-2023" class="menu-item menu-item-type-custom menu-item-object-custom">
                                <a href="/resume/resume.doc">Word</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2014" class="menu-item menu-item-type-post_type menu-item-object-page">
                        <a href="/contact/"><span>Contact Me</span></a>
                    </li>
                </ul>
            </div>
            <div class="clearboth"></div>
        </div><!-- #main_menu -->
        
        <div id="content">
            <div id="content_inner">
                <div id="main" class="ten columns clearfix">
                    <div id="main_inner">
                        <p>A while back I was reading an article that <a href="http://shiflett.org/" target="_blank">Chris Shiflett</a> wrote called <a href="http://shiflett.org/articles/the-truth-about-sessions" target="_blank">The Truth About Sessions</a>. He goes into all the details about the HTTP protocol and how it is stateless, how the developer has to add state at the application level. He goes on to talk about how PHP handles storing sessions and why the out of the box solution that PHP offers is not very secure. I suggest you read Chris&#39;s article to better understand how the internal PHP sessions work. One aspect that I dislike about the internal PHP sessions is that they are stored in files on the hard disk (usually /tmp/) by default. This means anyone with access to the machine has access to read the session data. I prefer to store my session information in the database to add an extra layer of security.  </p>

<p>Last year I had a talk with Chris about session handling and how to make it more secure. After a lengthy email conversation he brought light into the darkness that overwhelmed me. What I got from the conversation is that there is not much that you can rely on when it comes to making sure the visitor that comes to your site is who they say they are. Most people (as well as myself) would think well can&#39;t you just go by the IP that is returned from $_SERVER[&#39;REMOTE_ADDR&#39;]? The quick answer to this is no you cannot. Here is the explanation from Chris.  </p>

<p>Most notably, a single user can potentially use a different IP address for each request (as is the case with AOL users), and multiple users can potentially use the same IP address (as is the case in many computer labs using an HTTP proxy). These situations can cause a single user to appear to be many, or many users to appear to be one.  </p>

<p>Now if you think about it you will smack yourself on the head and say duh, if we base this on the IP anyone coming from a computer lab is on a local network and all computers will have the same IP address. We do not want to make that mistake. If the instructor is logged into their email any one of the users of another computer could potentially takeover the instructors session and read their emails. Obviously this is not a good idea.  </p>

<p>So how will we secure the sessions? First you must NEVER react harshly always assume that the session has not been hijacked. You do not want to over react and have it really be a true user who is impacted. We are going to create a custom session handler class skeleton that will at the very least store the sessions in the database. You can find the code below.  </p>

<p>The first thing we need to do is create a class with the necessary methods here is the skeleton.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Session</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$ses_id</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$table</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">open</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">gc</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now that you have the necessary methods you are going to have to put them to use. In order to use a class as a custom session handler you need to instruct PHP that you are going to do that and which methods should be called when necessary. In order to do this we need to create another file (I called this one global.php) that will instantiate the Session class. In this file we are creating an instance of the session class and then calling the php function session_set_save_handler(). You could easily use normal functions for a custom session handler, however because I am using a class you have to pass in an instance of the session object in an array also specifying the class method to use. Below is the code for the file.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;session.php&#39;</span><span class="p">);</span>

<span class="nv">$s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nv">$db</span><span class="p">);</span>

<span class="sd">/**</span>
<span class="sd"> * Change the save_handler to use</span>
<span class="sd"> * the class functions</span>
<span class="sd"> */</span>
<span class="nb">session_set_save_handler</span> <span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Notice that we are passing an instance of our database object into the session object. We will have to have a reference to this in order to store the sessions in the database. Also note that you are not required to use a database as a storage mechanism. You could very well use txt files stored in a secure directory, maybe even XML files if you wish. You can use whatever you wish for the storage mechanism just make sure that whatever you use is secured.  </p>

<p>Now that we have all of that out of the way it is time to talk about what happens when. When you setup a custom session handler the PHP session functions will call the appropriate custom method you define. The method names are a bit self-explanatory however I will cover them here. The open method will be called when you call session_start() this is where we will setup the session for use, things such as setup the database connection. On every page load all of these methods will be called one after another, it will open the session, read the session, write the session, close the session and then call the garbage collector (gc) method to remove all of the expired sessions.  </p>

<p>So now that we know what is going to happen when, I think it is time to actually make this thing come to life. Let&#39;s start with the constructor method. All we will do here is store the database connection into the session object for use when reading/writing and cleaning up sessions.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">,</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">=</span> <span class="nv">$table</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Next we will implement the open method, we are not going to do a lot in this method. All we are going to do here is set the session lifetime based on the value in the PHP configuration.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">,</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">=</span> <span class="nv">$table</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Note that because the session handler requires it we still have to accept the $path and $name as parameters for our method, however since we are using a database for our storage mechanism we are not going to put them to use. All I did in this method was set the session lifetime based on the value in the PHP configuration. You can set this to whatever you would like to however it must be set in seconds.  </p>

<p>Moving on we need to implement the close method, all that is done here is a bit of garbage cleanup. We do not want any expired sessions hanging out in the database. If someone closes the browser without the site destroying the session, the data will remain in the database table and will look like we have an open session when in fact we don&#39;t. This method will ensure that the sessions are cleared out.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">gc</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We have been talking about the gc method but I have yet to explain what it does. All the gc method does is delete all sessions from the database that have expired due to a timeout. We are figuring this out by calculating the time between the last access of the session subtracted from the current time. If the difference is greater than the session lifetime then we are dealing with an expired session.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">gc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$ses_life</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_life</span><span class="p">;</span>
    <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s1">&#39; DELETE FROM &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span> <span class="s1">&#39; WHERE last_access &lt; $ses_life &#39;</span><span class="p">;</span>

    <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Most of the work takes place in the read and write methods. I admit they are pretty simple as well. Actually there is not really anything overly complex about a custom session handler. The functionality that you will need in the read and write methods are below.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s1">&#39; SELECT * FROM &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span> <span class="s1">&#39; WHERE ses_id = &#39;</span><span class="nv">$ses_id</span><span class="p">;</span>
    <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$session_num</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">NumRows</span><span class="p">(</span><span class="nv">$session_res</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$session_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$session_row</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">FetchArray</span><span class="p">(</span><span class="nv">$session_res</span><span class="p">);</span>
        <span class="nv">$ses_data</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$session_row</span><span class="p">[</span><span class="s1">&#39;ses_value&#39;</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span> <span class="o">=</span> <span class="nv">$session_row</span><span class="p">[</span><span class="s1">&#39;ses_start&#39;</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span> <span class="o">=</span> <span class="nv">$ses_id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span><span class="p">))</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>

    <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s1">&#39; SELECT * FROM &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span> <span class="o">.</span> <span class="s1">&#39; WHERE ses_id=&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="p">;</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">NumRows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span> <span class="o">.</span> <span class="s1">&#39; (ses_id, last_access, ses_start, ses_value) VALUES (&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span> <span class="o">.</span> <span class="s1">&#39;, &#39;</span> <span class="o">.</span> <span class="nb">time</span><span class="p">()</span> <span class="o">.</span> <span class="s1">&#39;, &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span> <span class="o">.</span> <span class="s1">&#39;, &#39;</span> <span class="o">.</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s1">&#39; UPDATE &#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span> <span class="o">.</span> <span class="s1">&#39; SET last_access=&#39;</span> <span class="o">.</span> <span class="nb">time</span><span class="p">()</span> <span class="o">.</span> <span class="s1">&#39;, ses_value=&#39;</span> <span class="o">.</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39; WHERE ses_id=&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The code for the read and write methods is pretty self-explanatory however I am going to explain what is going on here. When you hit a page it reads the session data for your session id. It grabs the data from the database and it is put into the $_SESSION global array. When the page is finished processing it will call the write method to store the session values into the database.  </p>

<p>Now that we have all of that out of the way and the code will work as a basic custom session handler it&#39;s time to talk about the session security and how we should handle the sessions. As was said above you really have no way to know if a person is whom they are reporting they are. You cannot rely on the users IP address because they could be in a computer lab on a local network where all computers are routed through the same proxy. They also could be an AOL user who&#39;s IP can change between page loads due to the proxies that AOL uses.  </p>

<p>So if you cannot rely on the IP address to verify the person is whom they say, how can you protect this? As Chris has stated a typical HTTP request includes many optional headers. Here is an example HTTP request:  </p>

<pre>
GET / HTTP/1.1
Host: www.example.org
Cookie: PHPSESSID=12345
User-Agent: Mozilla/5.0 Galeon/1.2.6 (X11; Linux i686; U;) Gecko/20020916
Accept: text/html;q=0.9, */*;q=0.1
Accept-Charset: ISO-8859-1, utf-8;q=0.66, *;q=0.66
Accept-Language: en
</pre>

<p>Is it safe to assume that if a users browser sends a particular header that it will send it again in subsequent requests? Chris says that with very few exceptions this is true.  </p>

<p>However, if a user&#39;s browser does send these headers, is it safe to assume that they will be present in subsequent requests from the same browser? The answer is yes, with very few exceptions.  </p>

<p>The first thing we need to do is create the fingerprint We can do this in the session class, we will first create a parameter that will hold the secret key.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">private</span> <span class="nv">$fingerprintKey</span> <span class="o">=</span> <span class="s1">&#39;sdfkj43545lkjlkmndsf89a*(&amp;amp;(Nhnkj2h349*&amp;amp;(&#39;</span><span class="p">;</span>
</code></pre>
</div>

<p>This is where the system will get a bit more complex. Don&#39;t worry I am going to explain everything in depth. Before we jump into anymore code I am going to explain a bit about what we are going to accomplish. What our application will be doing is basically checking for abnormal activity from a user. We are not going to be assuming that the user will report any information to us and we are not going to require it. When I say this I mean that we are not going to rely on the users IP address and not going to assume that it wont change.  </p>

<p>The main goal in securing the session is to watch for abnormal behavior. If a user comes to your site and they are reporting the same User Agent over say 50 page loads and all the sudden it changes, that&#39;s abnormal and we should take action, however it should not be a severe action. If they come to your site and the User Agent is constantly changing, then this is very normal for the user, maybe we should check another value that is reported by the user. I am not going to jump in and try to make this fail proof for you what I am going to do is show you how would can implement this using only 1 value that is reported by the user. We will use the User Agent header which is sent by the browser most of the time. We will discuss what should happen when the user hits the threshold and then the User Agent changes and what you shouldn&#39;t do as well.  </p>

<p>For now your session class should look like the following.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Session</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$ses_id</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$table</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$ses_life</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$ses_start</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$fingerprintKey</span> <span class="o">=</span> <span class="s1">&#39;sdfkj43545lkjlkmndsf89a*(&amp;amp;(Nhnkj2h349*&amp;amp;(&#39;</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$threshold</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">private</span> <span class="nv">$fingerprintChecks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">,</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">=</span> <span class="nv">$table</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">open</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ses_life</span> <span class="o">=</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;session.gc_maxlifetime&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">gc</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">read</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM &quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span> <span class="s2">&quot; WHERE ses_id = &#39;</span><span class="si">$ses_id</span><span class="s2">&#39;&quot;</span><span class="p">;</span>
        <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

        <span class="nv">$session_num</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">NumRows</span><span class="p">(</span><span class="nv">$session_res</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$session_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$session_row</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">FetchArray</span><span class="p">(</span><span class="nv">$session_res</span><span class="p">);</span>
            <span class="nv">$ses_data</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$session_row</span><span class="p">[</span><span class="s2">&quot;ses_value&quot;</span><span class="p">]);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span> <span class="o">=</span> <span class="nv">$session_row</span><span class="p">[</span><span class="s1">&#39;ses_start&#39;</span><span class="p">];</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span> <span class="o">=</span> <span class="nv">$ses_id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
             <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">write</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span><span class="p">))</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
        <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM &quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span><span class="s2">&quot; WHERE ses_id=&#39;&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="o">.</span><span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
        <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">NumRows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span><span class="s2">&quot; (ses_id, last_access, ses_start, ses_value) VALUES (&#39;&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="o">.</span><span class="s2">&quot;&#39;, &quot;</span><span class="o">.</span><span class="nb">time</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_start</span><span class="o">.</span><span class="s2">&quot;, &#39;&quot;</span><span class="o">.</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;&#39;)&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span><span class="s2">&quot; SET last_access=&quot;</span><span class="o">.</span><span class="nb">time</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;, ses_value=&#39;&quot;</span><span class="o">.</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;&#39; WHERE ses_id=&#39;&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="o">.</span><span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$ses_id</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">gc</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$ses_life</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_life</span><span class="p">;</span>
        <span class="nv">$session_sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM &quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_table</span><span class="o">.</span> <span class="s2">&quot; WHERE last_access &lt; </span><span class="si">$ses_life</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$session_res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">Query</span><span class="p">(</span><span class="nv">$session_sql</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$session_res</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now that we know what we are going to do it is time to look at the code that we will put into the Session class and explain what it does.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">HijackCheck</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="c1">// check the users user agent activity.</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]))</span> 
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">PW_MAX_CHECKS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> 
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]))</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">PW_MAX_CHECKS</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

                    <span class="c1">// check the password provided, if invalid show the password form again here.</span>
                <span class="p">}</span>
                <span class="k">else</span> 
                <span class="p">{</span>
                    <span class="c1">// reset our session variables.</span>
                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]);</span>
                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]);</span>
                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;PW_CHECKS&#39;</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destroy</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_ses_id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// check to see if UA_CHECKS is instantiated, if not set it to 0</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]))</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// check to see if the users IP address has been set, if not set it.</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]))</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fingerprint</span><span class="o">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]);</span>

    <span class="c1">// check to see if the UA has changed</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fingerprint</span><span class="o">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// Check to see if the UA_CHECKS has been completed UA_THRESHOLD times</span>
        <span class="c1">// update the new UserAgent</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">UA_THRESHOLD</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// It&#39;s not normal for the users UA to change frequently</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$pwError</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;UA_CHECKS&#39;</span><span class="p">]);</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The first thing we need to do are set our limits.  We will need to set a user agent threshold. What is the user agent threshold?  The threshold is a number let&#39;s say 25.  This is the number that the user needs to reach without the user agent changing.  If they reach this number we are going to assume that it is not normal for the user agent for this user to change.  On every page load this method will be called and it will check the user agent against the one from the first page load (if there is one)  If it does not change it will increment the UA_CHECKS session variable.  Once the UA_CHECKS hits the UA_THRESHOLD we know that the user has loaded 25 pages without a change in the user agent.  If all of the sudden the user agent changes we know that something went wrong.  </p>

<p>However we are going to treat this situation lightly, we are not going to assume that someone hijacked the system.  What we will do is just show the user the password form and make them provide their password again.  Since we are treating this situation lightly but we also do not want a hijacked session to remain open we will have to set a limit on the password checks.  I feel a good number for PW_MAX_CHECKS would be 3.  If the user does not provide the correct password after 3 attempts we will destroy the session. Doing this will log the user out of the system and any data stored in the session will be removed.  </p>

<p>You will need to add the definitions for the 2 constants to the global.php file. It should now look like the following.  </p>
<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">&#39;UA_THRESHOLD&#39;</span><span class="p">,</span> <span class="mi">25</span> <span class="p">);</span>
<span class="nb">define</span><span class="p">(</span> <span class="s1">&#39;PW_MAX_CHECKS&#39;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">&#39;session.php&#39;</span><span class="p">);</span>

<span class="nv">$s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nv">$db</span><span class="p">);</span>

<span class="sd">/**</span>
<span class="sd"> * Change the save_handler to use</span>
<span class="sd"> * the class functions</span>
<span class="sd"> */</span>
<span class="nb">session_set_save_handler</span> <span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>

<p>So now if someone is browsing the site while logged in, and something out of the ordinary happens it will prompt the user for their password and if they do not provide the correct password after 3 attempts it will destroy the session.  Handling the situation lightly like this allows us to not assume anything and only react when there is definitely a problem.  If someone comes to the site and the user agent changes every 5 pages we will assume that is normal and we do not do anything.  You could take this class quite a bit further such as checking the users IP after the user fails the user agent checks but I think that would be overkill.  </p>

<p>You can also take this further because now you have a custom session handler you can log what browser each user is using, the IP and keep your site&#39;s own traffic stats if you wanted.  I have this class extended to show what type of user the person is (Guest, Client, Admin) and I was even logging the pages that they have navigated and the time on each page.  Logging this in the admin interface would allow me to see which pages were most important to my users and also see how long the average user would remain on my site.  There are many directions you can take this, let me know which direction you go.</p>

                        <div class="clearboth"></div>
                    </div><!-- #main_inner -->
                </div><!-- #main -->

                                <div id="sidebar" class="six columns">
                    <div id="sidebar_inner">
                        <div id="search-3" class="widget widget_search">
                            <form id="searchform">
                                <input type="text" name="s" id="s" value="Enter Your Search Term" onfocus="if(this.value=='Enter Your Search Term')this.value='';" onblur="if(this.value=='')this.value='Enter Your Search Term';">
                            </form>
                        </div>
						<div id="themes">
							<div id="style-switcher">
								<span style="font-size: 16px;">Select Theme: </span>
								<select name="switcher" id="switcher" style="pretty dk">
									<option value='light_lightblue'>Default</option>
									<option value='gravity'>Gravity</option>
									<option value='dark_blue'>Dark Blue</option>
									<option value='dark_coral'>Dark Coral</option>
									<option value='dark_crimson'>Dark Crimson</option>
									<option value='dark_glance'>Dark Glance</option>
									<option value='dark_green'>Dark Green</option>
									<option value='dark_hotpink'>Dark Hotpink</option>
								</select>
							</div>
						</div>
                        
						<div class="clearboth"></div>
                        
                        <div id="categories-3" class="widget widget_categories">
                            <h4 class="widgettitle"><span>Categories</span></h4>
                            <ul>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/development/" title="Development">Development</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/reviews/" title="Reviews">Reviews</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/development/" title="Development">Development</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/mac/" title="Mac">Mac</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/raves/" title="Raves">Raves</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/reviews/" title="Reviews">Reviews</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/software/" title="Software">Software</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/rants/" title="Rants">Rants</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/uncategorized/" title="Uncategorized">Uncategorized</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/entertainment/" title="Entertainment">Entertainment</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/local/" title="Local">Local</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/news/" title="News">News</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/work/" title="Work">Work</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/internet/" title="Internet">Internet</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/jokes/" title="Jokes">Jokes</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/tutorials/" title="Tutorials">Tutorials</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/websites/" title="Websites">Websites</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/tv/" title="Tv">Tv</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/ppp/" title="Ppp">Ppp</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/javascript/" title="Javascript">Javascript</a>
                                </li>
                                
                        	    <li class="cat-item cat-item-4">
                                    <a href="/category/useful/" title="Useful">Useful</a>
                                </li>
                                
                      		</ul>
                        </div>
                        
                        <div class="clearboth"></div>
                        
                        <div id="recent-posts-3" class="widget widget_recent_entries">
                            <h4 class="widgettitle"><span>Recent Posts</span></h4>
                            <ul>
                                <li><a href="http://www.josephcrawford.com/2012/12/test/" title="Test">Test</a></li>
                                <li><a href="http://www.josephcrawford.com/2012/12/php-master-series/" title="PHP Master Series">PHP Master Series</a></li>
                                <li><a href="http://www.josephcrawford.com/2012/11/a-new-look/" title="A New Look">A New Look</a></li>
                                <li><a href="http://www.josephcrawford.com/2012/10/review-timing/" title="Review: Timing">Review: Timing</a></li>
                                <li><a href="http://www.josephcrawford.com/2012/10/review-markdown-pro/" title="Review: Markdown Pro">Review: Markdown Pro</a></li>
                            </ul>
                        </div>
                        <div id="top-posts-2" class="widget widget_top-posts"><h4 class="widgettitle"><span>Top Posts &amp; Pages</span></h4><ul class='widgets-list-layout no-grav'>
                            <li>
                                <img src="http://1.gravatar.com/avatar/bf6bc93ab3eeef8996970fa8ac9895a3?s=40&#038;d=http%3A%2F%2Fs1.wp.com%2Fi%2Flogo%2Fwhite-gray-80.png%3Fs%3D40&#038;r=PG" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/php-articles/going-deep-inside-php-sessions/" class="bump-view" data-bump-view="tp">Going deep inside PHP sessions</a></div>
                            </li>
                            <li>
                                <img src="http://1.gravatar.com/avatar/bf6bc93ab3eeef8996970fa8ac9895a3?s=40&#038;d=http%3A%2F%2Fs1.wp.com%2Fi%2Flogo%2Fwhite-gray-80.png%3Fs%3D40&#038;r=PG" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2012/12/php-master-series/" class="bump-view" data-bump-view="tp">PHP Master Series</a></div>
                            </li>
                            <li>
                                <img src="http://i0.wp.com/www.josephcrawford.com/wp-content/uploads/2008/04/tagchimp.png?resize=40%2C40" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2008/05/metax-and-tagchimp/" class="bump-view" data-bump-view="tp">MetaX and tagChimp</a></div>
                            </li>
                            <li>
                                <img src="http://i1.wp.com/www.josephcrawford.com/wp-content/uploads/2009/05/ffusa-featured.png?resize=40%2C40" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2009/05/first-financial-usa-ffusa/" class="bump-view" data-bump-view="tp">First Financial USA (FFUSA)</a></div>
                            </li>
                            <li>
                                <img src="http://i0.wp.com/www.josephcrawford.com/wp-content/uploads/2009/08/WebOS.png?resize=40%2C40" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2009/08/a-basic-webos-application-and-the-depot/" class="bump-view" data-bump-view="tp">A Basic WebOS Application and the Depot</a></div>
                            </li>
                            <li>
                                <img src="http://i0.wp.com/www.josephcrawford.com/wp-content/uploads/2006/11/photo_isight.jpeg?resize=40%2C40" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2006/11/scary-isight-trick/" class="bump-view" data-bump-view="tp">Scary iSight Trick</a></div>
                            </li>
                            <li>
                                <img src="http://1.gravatar.com/avatar/bf6bc93ab3eeef8996970fa8ac9895a3?s=40&#038;d=http%3A%2F%2Fs1.wp.com%2Fi%2Flogo%2Fwhite-gray-80.png%3Fs%3D40&#038;r=PG" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/2010/09/bose-companion-5-and-ubuntu/" class="bump-view" data-bump-view="tp">Bose Companion 5 and Ubuntu (SOLVED)</a></div>
                            </li>
                            <li>
                                <img src="http://1.gravatar.com/avatar/bf6bc93ab3eeef8996970fa8ac9895a3?s=40&#038;d=http%3A%2F%2Fs1.wp.com%2Fi%2Flogo%2Fwhite-gray-80.png%3Fs%3D40&#038;r=PG" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/about/" class="bump-view" data-bump-view="tp">About</a></div>
                            </li>
                            <li>
                                <img src="http://1.gravatar.com/avatar/bf6bc93ab3eeef8996970fa8ac9895a3?s=40&#038;d=http%3A%2F%2Fs1.wp.com%2Fi%2Flogo%2Fwhite-gray-80.png%3Fs%3D40&#038;r=PG" class='widgets-list-layout-blavatar' />
                                <div class="widgets-list-layout-links"><a href="http://www.josephcrawford.com/macdev-articles/using-foundations-nslog-function/" class="bump-view" data-bump-view="tp">Using Foundation&#039;s NSLog Function</a></div>
                            </li>
                        </ul>
                    </div>
                    <div id="popularwidget-2" class="widget miss_popular_widget">
                        <h4 class="widgettitle">
                            <span>Popular Posts</span>
                        </h4>
                        <ul class="post_list small_post_list">
                            <li class="post_list_module">
                                <div class="post_list_image">
                                    <a href="http://www.josephcrawford.com/2007/11/phpwomen-a-site-for-women-programming-php/" title="PHPWomen: A site for women programming PHP">
                                        <img class="hover_fade_js" src="http://www.josephcrawford.com/wp-content/themes/radiostation/cache/php_women_2010_large_calendar-p158038689179469171b7aic_400-119x72.jpeg" title="PHPWomen: A site for women programming PHP" alt="Php Women 2010 Large Calendar P158038689179469171b7aic 400" width="119" height="72" />
                                    </a>
                                </div>
                                <div class="post_list_content">
                                    <p class="post_title">
                                        <a rel="bookmark" href="http://www.josephcrawford.com/2007/11/phpwomen-a-site-for-women-programming-php/" title="PHPWomen: A site for women programming PHP">PHPWomen: A site for women programming PHP</a>
                                    </p>
                                </div>
                            </li>
                            <li class="post_list_module">
                                <div class="post_list_image">
                                    <a href="http://www.josephcrawford.com/2009/03/the-new-itunes-hdcp-content/" title="The New iTunes HDCP Content">
                                        <img class="hover_fade_js" src="http://www.josephcrawford.com/wp-content/themes/radiostation/cache/hdcp-featured-119x72.png" title="The New iTunes HDCP Content" alt="Hdcp Featured" width="119" height="72" />
                                    </a>
                                </div>
                                <div class="post_list_content">
                                    <p class="post_title">
                                        <a rel="bookmark" href="http://www.josephcrawford.com/2009/03/the-new-itunes-hdcp-content/" title="The New iTunes HDCP Content">The New iTunes HDCP Content</a>
                                    </p>
                                </div>
                            </li>
                            <li class="post_list_module">
                                <div class="post_list_image">
                                    <a href="http://www.josephcrawford.com/2007/10/customizing-the-leopard-dock/" title="Customizing the Leopard Dock">
                                        <img class="hover_fade_js" src="http://www.josephcrawford.com/wp-content/themes/radiostation/cache/dock-featured-119x72.png" title="Customizing the Leopard Dock" alt="Dock Featured" width="119" height="72" />
                                    </a>
                                </div>
                                <div class="post_list_content">
                                    <p class="post_title">
                                        <a rel="bookmark" href="http://www.josephcrawford.com/2007/10/customizing-the-leopard-dock/" title="Customizing the Leopard Dock">Customizing the Leopard Dock</a>
                                    </p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div id="popularwidget-2" class="widget">
                        <h4 class="widgettitle">
                            <span>Tag Cloud</span>
                        </h4>
                        <span style='font-size: 75%'><a href='/tags/php/'>php</a></span>
<span style='font-size: 75%'><a href='/tags/server-side/'>server-side</a></span>
<span style='font-size: 75%'><a href='/tags/best-practices/'>best-practices</a></span>
<span style='font-size: 75%'><a href='/tags/ide/'>ide</a></span>
<span style='font-size: 75%'><a href='/tags/software/'>software</a></span>
<span style='font-size: 151%'><a href='/tags/development/'>Development</a></span>
<span style='font-size: 170%'><a href='/tags/mac/'>Mac</a></span>
<span style='font-size: 280%'><a href='/tags/raves/'>Raves</a></span>
<span style='font-size: 249%'><a href='/tags/reviews/'>Reviews</a></span>
<span style='font-size: 108%'><a href='/tags/software/'>Software</a></span>
<span style='font-size: 180%'><a href='/tags/rants/'>Rants</a></span>
<span style='font-size: 75%'><a href='/tags/uncategorized/'>Uncategorized</a></span>
<span style='font-size: 280%'><a href='/tags/entertainment/'>Entertainment</a></span>
<span style='font-size: 129%'><a href='/tags/local/'>Local</a></span>
<span style='font-size: 280%'><a href='/tags/news/'>News</a></span>
<span style='font-size: 75%'><a href='/tags/work/'>Work</a></span>
<span style='font-size: 280%'><a href='/tags/internet/'>Internet</a></span>
<span style='font-size: 75%'><a href='/tags/jokes/'>Jokes</a></span>
<span style='font-size: 86%'><a href='/tags/tutorials/'>Tutorials</a></span>
<span style='font-size: 196%'><a href='/tags/websites/'>Websites</a></span>
<span style='font-size: 75%'><a href='/tags/tv/'>TV</a></span>
<span style='font-size: 75%'><a href='/tags/ppp/'>PPP</a></span>
<span style='font-size: 75%'><a href='/tags/javascript/'>JavaScript</a></span>
<span style='font-size: 75%'><a href='/tags/php/'>PHP</a></span>
<span style='font-size: 103%'><a href='/tags/useful/'>Useful</a></span>
<span style='font-size: 75%'><a href='/tags/frameworks/'>Frameworks</a></span>
<span style='font-size: 75%'><a href='/tags/family/'>Family</a></span>
<span style='font-size: 75%'><a href='/tags/tmc/'>TMC</a></span>
<span style='font-size: 75%'><a href='/tags/macdev/'>MacDev</a></span>
<span style='font-size: 75%'><a href='/tags/scams/'>Scams</a></span>
<span style='font-size: 75%'><a href='/tags/palm/'>Palm</a></span>
<span style='font-size: 75%'><a href='/tags/css/'>CSS</a></span>
<span style='font-size: 75%'><a href='/tags/political/'>Political</a></span>
<span style='font-size: 75%'><a href='/tags/recruiters/'>Recruiters</a></span>

                        <!-- tagcloud goes here -->
                    </div>
                </div><!-- #sidebar_inner -->
            </div><!-- #sidebar -->
                    
                <div class="clearboth"></div>
            </div><!-- #content_inner -->
        </div><!-- #content -->
    </div> <!-- .container -->
    
    <div id="footer">
        <div class="background">
            <div class="background"></div>
        </div>
        <div class="container">
            <div class="sixteen columns">
                <div class="one_fourth"><div id="cr_plmanager_widget-2" class="widget widget_cr_plmanager_widget"><h4 class="widgettitle"><span>Sponsors</span></h4><div class="textwidget"><a href='http://www.shimonsandler.com/'>SEO Consulting</a></div></div></div><div class="three_fourth last"></div><div class="clearboth"></div>          </div>
        </div>
    </div><!-- #footer -->
<div id="sub_footer"><div class="container"><div class="sixteen columns"><div class="copyright_text">Copyright &copy; "Joseph Crawford" 2012. All rights reserved. </div></div><!-- columns --></div><!-- container --></div><!-- #sub_footer --></div><!-- #page_inner -->
<img src="http://www.josephcrawford.com/wp-content/plugins/welamazonadds/images/empty.png?n=0187a1f2eb&priceIndicator=&backgroundColor=%23F4F4F4&borderColor=%23000000&textColor=%23000000&linkColor=%230000FF&target=_blank&imageSize=IS2" src="" width="0" height="0" id="WAA_interim" /> <div style="display:none">
    <div class="grofile-hash-map-bf6bc93ab3eeef8996970fa8ac9895a3">
    </div>
    </div>
<script type='text/javascript' src='http://www.josephcrawford.com/wp-content/themes/radiostation/framework/scripts/prettyphoto/js/jquery.prettyPhoto.js?ver=1.0.8'></script>
<script type='text/javascript' src='http://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201251'></script>
<script type='text/javascript' src='http://s.gravatar.com/js/gprofiles.js?ver=2012Decaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.josephcrawford.com/wp-content/plugins/jetpack/modules/wpgroho.js?ver=3.5'></script>

    <script src="http://stats.wordpress.com/e-201251.js" type="text/javascript"></script>
    <script type="text/javascript">
    st_go({v:'ext',j:'1:2.0.4',blog:'6829527',post:'0',tz:'0'});
    var load_cmc = function(){linktracker_init(6829527,0,2);};
    if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
    else load_cmc();
    </script>
<style type='text/css'>img#wpstats{display:none}</style><script type="text/javascript">/* <![CDATA[ */jQuery( '.blog_layout1' ).preloader({ imgSelector: '.blog_index_image_load span img', imgAppend: '.blog_index_image_load' });jQuery( '.blog_layout2' ).preloader({ imgSelector: '.blog_index_image_load span img', imgAppend: '.blog_index_image_load' });jQuery( '.blog_layout3' ).preloader({ imgSelector: '.blog_index_image_load span img', imgAppend: '.blog_index_image_load' });jQuery( '.single_post_module' ).preloader({ imgSelector: '.blog_index_image_load span img', imgAppend: '.blog_index_image_load' });jQuery( '.one_column_portfolio' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.two_column_portfolio' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.three_column_portfolio' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.four_column_portfolio' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.portfolio_gallery.large_post_list' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.portfolio_gallery.medium_post_list' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '.portfolio_gallery.small_post_list' ).preloader({ imgSelector: '.portfolio_img_load span img', imgAppend: '.portfolio_img_load' });jQuery( '#main_inner' ).preloader({ imgSelector: '.portfolio_full_image span img', imgAppend: '.portfolio_full_image' });jQuery( '#main_inner' ).preloader({ imgSelector: '.blog_sc_image_load span img', imgAppend: '.blog_sc_image_load' });jQuery( '#main_inner' ).preloader({ imgSelector: '.styled_image_load span img', imgAppend: '.styled_image_load' });jQuery( '#intro_inner' ).preloader({ imgSelector: '.styled_image_load span img', imgAppend: '.styled_image_load' });/* ]]> */</script><!--[if lt IE 10]><script type="text/javascript">jQuery(".flex-imageLink img").animate({"height":"386px"},500);</script><![endif]--> </body>
</html>