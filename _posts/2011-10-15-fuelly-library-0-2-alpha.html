--- 
status: publish
meta: 
  _thumbnail_id: "1791"
  views: "38"
  _aktt_hash_meta: ""
  _layout: right_sidebar
  aktt_notify_twitter: "no"
  _bitly_trim: http://www.josephcrawford.com/?p=1502
  _edit_last: "1"
  _radiostation_dependencies: s:6:"a:0:{}";
type: post
layout: post
title: Fuelly Library (0.2-alpha)
published: true
tags: 
- Entertainment
- Frameworks
- Internet
- PHP
- Raves
- Software
- Useful
- Websites
---
I have been using <a href="http://www.fuelly.com" title="Fuelly" target="_blank">Fuelly.com</a> for a while now to track my gas mileage on my motorcycle.  Every-time I fill-up my tank I send an SMS to Fuelly with the odometer reading, the price per gallon and how many gallons I put into the bike.

	A sample SMS message that I send looks like this
	<blockquote>
	h 2799 4.099 3.06
	</blockquote>

	I prefix the message with the letter I have assigned to the vehicle in Fuelly so that it knows which vehicle to apply the fuel-up to.  This is very handy since Fuelly does all the calculations and shows my history for gas mileage.  However I was looking for a way to get the data from Fuelly to display on my site.  Currently even with the demand high Fuelly does not have the proper resources to develop and support an API at this time.  I sat down over the last week and began working on a <a href='http://www.josephcrawford.com/wp-content/uploads/2011/10/Fuelly-0.2-alpha.zip'>library of Fuelly classes (Fuelly-0.2-alpha)</a> that could be used to fetch your data from the site.  Currently it requires that you provide a valid Fuelly username and password to fetch data but in the future I plan to remove this dependency.  In the future when you use this library to reach out to Fuelly if you do not pass a valid user object it will fetch only the "public" data that it can.  If you pass it a valid authenticated user object then it will also grab data which only you can see when you log-in. 
	<!--more-->

	Currently it is very simple, the library consists of a handful of classes which are outlined below with a description of what each does.

	Fulley_Scraper - This is the heart of the library, it is the class that actually reaches out to Fuelly and fetches all the statistics.  It's then responsible for populating the other objects with the data.

	Fuelly_Response - This object is really just a container object at this time, it's only duty right now is to hold references to all the other objects keeping things organized nicely.  In the future I may add more functionality to this object but not at this time.

	Fuelly_User - This is the user object which you create with your username and password for Fuelly.  It is used for authenticated requests throughout the scraping process.

	Fuelly_Vehicle - This is the object that will hold all of the vehicle information along with a collection of fuel-ups for that particular vehicle.  Currently this is solely a container object as well.

	Fuelly_Fuelup - This object is what is populated for every fuel-up added to a vehicle.  The Fuelly_Vehicle holds a collection of fuel-ups which are all instances of Fuelly_Fuelup

	Fuelly_Object - This is the base object which all other objects inherit from.  It provides some base functionality such as magic __get, __set and __call methods.

	Fuelly_Exception - This is just an exception class which currently only inherits the functionality of the built-in Exception object.

	Now that you know what all of the classes are and what they do it's time to look at some actual implementation code.  I have the library structured like the following:

	|- index.php
	|-- lib/
	|---- Fuelly/
	|------ Exception.php
	|------ Fuelup.php
	|------ Object.php
	|------ Scraper.php
	|------ Vehicle.php

	The index file is the where the process begins.  It does some preparatory tasks such as setting the include path and implementing an autoloader function.  Once this is setup you simply create an instance of Fuelly_User with your username and password and then you pass the Fuelly_User object into an instance of Fuelly_Scraper.  Once you have the scraper object there are 2 ways you can use it.  You can simply call the run method with no parameters and this will reach out and collect the statistics for every vehicle you have listed in Fuelly.  The other option is to pass in a vehicle display name and the library will only collect statistics on the specified vehicle.

	<pre lang="php" line="1">
	<?php
	date_default_timezone_set('America/New_York');
	ini_set('include_path', get_include_path() . PATH_SEPARATOR . realpath(dirname(__FILE__)).'/lib/');


	function __autoload($className) {
		$segments = explode('_', $className);
		$className = implode('/', $segments);

		if(file_exists('lib/'.$className . '.php')) include 'lib/'.$className . '.php';
	}

	try {
		$user = new Fuelly_User('test@mailinator.com', 'test');

		$response = Fuelly_Scraper::getInstance($user)->run();

		var_dump($response); exit;	

	} catch(Fuelly_Exception $e) {
		echo $e->getMessage();
	}
	</pre>

	Ok I get it, implementation is easy but what does the output look like?  As you can see above I am currently just dumping the response object so that you can see the values, however there is much more you can do with this.  For instance you could total up the total miles driven for all vehicles or you could calculate how many miles you have driven over a date range, or for a specific day such as yesterday or today.  Currently none of the features I just talked about are implemented however it would be pretty easy to calculate.  For instance to calculate the total miles driven for all vehicles you could do something like this.

	<pre lang="php" line="1">
	<?php
	date_default_timezone_set('America/New_York');
	ini_set('include_path', get_include_path() . PATH_SEPARATOR . realpath(dirname(__FILE__)).'/lib/');


	function __autoload($className) {
		$segments = explode('_', $className);
		$className = implode('/', $segments);

		if(file_exists('lib/'.$className . '.php')) include 'lib/'.$className . '.php';
	}

	try {
		$user = new Fuelly_User('test@mailinator.com', 'test');

		$response = Fuelly_Scraper::getInstance($user)->run();

	        $totalMiles = 0;
	        foreach($response->getVehicles() as $vehicle) {
	                $totalMiles += $vehicle->getTotalMilesTracked();
	        }

	        echo "I have driven a total of ".$totalMiles." in all vehicles tracked by Fuelly.";

	} catch(Fuelly_Exception $e) {
		echo $e->getMessage();
	}
	</pre>

	Currently there is no documentation for this code other than reading through it to see what is going on however that will be coming in the near future as well.  I want to get the library somewhat evolved before spending too much time on the documentation for the methods, etc.  PHPDoc will be a friend over the next few months.

	Ok so you are dying to see what a response object looks like when it's all populated here it is:

	<pre lang="php" line="1">
	object(Fuelly_Response)#3 (1) {
	  ["_properties":protected]=>
	  array(6) {
	    ["searchByVehicleName"]=>
	    bool(false)
	    ["searchVehicleFound"]=>
	    bool(false)
	    ["searchVehicleString"]=>
	    string(0) ""
	    ["totalVehiclesFound"]=>
	    int(1)
	    ["user"]=>
	    object(Fuelly_User)#1 (1) {
	      ["_properties":protected]=>
	      array(4) {
	        ["email"]=>
	        string(19) "test@mailinator.com"
	        ["password"]=>
	        string(4) "test"
	        ["displayName"]=>
	        string(6) "test27"
	        ["isLoggedIn"]=>
	        bool(true)
	      }
	    }
	    ["vehicles"]=>
	    array(1) {
	      ["2WT"]=>
	      object(Fuelly_Vehicle)#11 (1) {
	        ["_properties":protected]=>
	        array(15) {
	          ["id"]=>
	          string(5) "93749"
	          ["name"]=>
	          string(3) "2WT"
	          ["displayName"]=>
	          string(3) "2WT"
	          ["avgMilesPerGallon"]=>
	          string(4) "47.5"
	          ["lastMilesPerGallon"]=>
	          string(4) "64.5"
	          ["bestMilesPerGallon"]=>
	          string(4) "64.5"
	          ["avgPricePerGallon"]=>
	          string(5) "$3.92"
	          ["avgPricePerFuelUp"]=>
	          string(6) "$12.14"
	          ["avgPricePerMile"]=>
	          string(6) "$0.082"
	          ["totalFuelups"]=>
	          int(5)
	          ["totalSpent"]=>
	          string(6) "$60.71"
	          ["totalMilesTracked"]=>
	          string(3) "589"
	          ["totalMilesToday"]=>
	          int(0)
	          ["hasFirstFuelupOfTheDayBeenCompleted"]=>
	          bool(false)
	          ["fuelups"]=>
	          array(5) {
	            [0]=>
	            object(Fuelly_Fuelup)#18 (1) {
	              ["_properties":protected]=>
	              array(9) {
	                ["timestamp"]=>
	                int(1318365120)
	                ["odometer"]=>
	                string(3) "590"
	                ["miles"]=>
	                int(200)
	                ["gallons"]=>
	                string(3) "3.1"
	                ["milesPerGallon"]=>
	                float(64.5)
	                ["pricePerGallon"]=>
	                string(6) "$3.899"
	                ["note"]=>
	                string(16) "Cumberland Farms"
	                ["addedBy"]=>
	                string(6) "test27"
	                ["total"]=>
	                string(6) "$12.09"
	              }
	            }
	            [1]=>
	            object(Fuelly_Fuelup)#19 (1) {
	              ["_properties":protected]=>
	              array(9) {
	                ["timestamp"]=>
	                int(1317663120)
	                ["odometer"]=>
	                string(3) "390"
	                ["miles"]=>
	                int(109)
	                ["gallons"]=>
	                string(3) "3.1"
	                ["milesPerGallon"]=>
	                float(35.2)
	                ["pricePerGallon"]=>
	                string(6) "$3.999"
	                ["note"]=>
	                string(5) "Mobil"
	                ["addedBy"]=>
	                string(6) "test27"
	                ["total"]=>
	                string(6) "$12.40"
	              }
	            }
	            [2]=>
	            object(Fuelly_Fuelup)#21 (1) {
	              ["_properties":protected]=>
	              array(9) {
	                ["timestamp"]=>
	                int(1317576660)
	                ["odometer"]=>
	                string(3) "281"
	                ["miles"]=>
	                int(140)
	                ["gallons"]=>
	                string(3) "3.1"
	                ["milesPerGallon"]=>
	                float(45.2)
	                ["pricePerGallon"]=>
	                string(6) "$3.799"
	                ["note"]=>
	                string(0) ""
	                ["addedBy"]=>
	                string(6) "test27"
	                ["total"]=>
	                string(6) "$11.78"
	              }
	            }
	            [3]=>
	            object(Fuelly_Fuelup)#22 (1) {
	              ["_properties":protected]=>
	              array(9) {
	                ["timestamp"]=>
	                int(1317490200)
	                ["odometer"]=>
	                string(3) "141"
	                ["miles"]=>
	                int(140)
	                ["gallons"]=>
	                string(3) "3.1"
	                ["milesPerGallon"]=>
	                float(45.2)
	                ["pricePerGallon"]=>
	                string(6) "$3.899"
	                ["note"]=>
	                string(0) ""
	                ["addedBy"]=>
	                string(6) "test27"
	                ["total"]=>
	                string(6) "$12.09"
	              }
	            }
	            [4]=>
	            object(Fuelly_Fuelup)#23 (1) {
	              ["_properties":protected]=>
	              array(9) {
	                ["timestamp"]=>
	                int(1317490140)
	                ["odometer"]=>
	                string(1) "1"
	                ["miles"]=>
	                int(0)
	                ["gallons"]=>
	                string(3) "3.1"
	                ["milesPerGallon"]=>
	                float(0)
	                ["pricePerGallon"]=>
	                string(6) "$3.989"
	                ["note"]=>
	                string(0) ""
	                ["addedBy"]=>
	                string(6) "test27"
	                ["total"]=>
	                string(6) "$12.37"
	              }
	            }
	          }
	        }
	      }
	    }
	  }
	}
	</pre>

	Now what happens when you search for a specific vehicle which cannot be located in Fuelly?  Check the response below.

	<pre lang="php" line="1">
	object(Fuelly_Response)#3 (1) {
	  ["_properties":protected]=>
	  array(6) {
	    ["searchByVehicleName"]=>
	    bool(true)
	    ["searchVehicleFound"]=>
	    bool(false)
	    ["searchVehicleString"]=>
	    string(5) "MyCar"
	    ["totalVehiclesFound"]=>
	    int(0)
	    ["user"]=>
	    object(Fuelly_User)#1 (1) {
	      ["_properties":protected]=>
	      array(4) {
	        ["email"]=>
	        string(19) "test@mailinator.com"
	        ["password"]=>
	        string(4) "test"
	        ["displayName"]=>
	        string(6) "test27"
	        ["isLoggedIn"]=>
	        bool(true)
	      }
	    }
	    ["vehicles"]=>
	    array(0) {
	    }
	  }
	}
	</pre>

	You guessed it, it will return a response object without any vehicles.  Now one thing I want to point out is that the response object has a few properties that are related to the searching of vehicles.  You can see if a search for a vehicle was requested, if any match was found and also the name of the vehicle that is being searched for.

	You might have noticed that in the response object I have not parsed out any of the $ in the prices.  This is because I have not really played around with Fuelly too much and am not sure if Fuelly supports other languages yet or if everything is always in USD.  Once I figure that out I will be sure to have the code properly handle the currency symbols along with number_format rules for those languages.  I also have not supported posting any data to Fuelly, this might come in the future as it is possible however I wanted to start with pulling the data first as that is what I have a use for.

	I have licensed this code under the Creative Commons license so please feel free to use it as you wish.  If you end up using this code please let me know, as well if you have ideas for improvement or enhancement let me know that too.

	This library would not have had nearly as much progress made if it were not for the assistance of other people in ##php on irc.freenode.net most notably ymas and TML so a BIG THANK YOU to those guys for dealing with my XPath and DOMDocument questions.
